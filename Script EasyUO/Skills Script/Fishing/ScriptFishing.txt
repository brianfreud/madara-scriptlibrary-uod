; Ecco qui il mio script per la pesca, salite su una barca fermandovi in un punto qualsiasi. 
; Portate nello zaino un cleaver e la canna da pesca.
; Muovete la barca e posizionatevi in un punto in cui potete muovervi in avanti per molto tempo.
; Ho disabilitato la funzione che porta le perle a casa... Altrimenti le portate a casa mia  
; Per portarle a casa vostra dovete lavorare un po' sullo script!

InitEvents
;Sets up variables
set %Fish IND_HND_EQD_DQD_GQD_FQD
set %specFish YDF
set %seaSerpent KI_RI_OD
set %Xmin 4586
set %Xmax 5014

;Casta protection
gosub Cast_Protection

main:
;Verifica canna da pesca
finditem KDF C
if #findkind = -1
{
event sysmessage non hai canne da pesca
halt
}

SET #LOBJECTID #FINDID
EVENT MACRO 17 0

click 460 340

gosub waitfinishedfishing

if #CHARPOSX > %Xmax
gosub moveup

;gosub PosaPerle
gosub TagliaPesci

finditem %seaSerpent G_10
if #findkind <> -1
gosub Difenditi

goto main

sub waitfinishedfishing
set %jIndex #jIndex
set %timer #SCNT
Loopwaitfishing:
wait 0
if %jIndex <> #jIndex
{
set %startIndex %jIndex + 1
for %scanCounter %startIndex #jIndex
{
scanjournal %scanCounter
if you_pull_out_an_item in #journal
{
deleteJournal
return
}
if you_pull_out in #journal
{
deleteJournal
wait 2s
return
}
if you_fish_a_while in #journal
{
deleteJournal
return
}

if the_fish_don in #journal
{
deleteJournal
gosub move
return
}
if your_fishing_pole_bends in #journal
{
deleteJournal
return
}
if you_must_wait_to_perform in #journal
{
deleteJournal
return
}
wait 2s
if #TARGCURS = 1
{
deleteJournal
return
}
if #enemyid <> N/A
gosub Difenditi
}
set %jIndex #jIndex

}
if ( %timer + 10 ) < #SCNT
{
deleteJournal
return
}

goto Loopwaitfishing

return


sub move
EVENT MACRO 1 0 forward one
wait 2s
EVENT MACRO 1 0 forward one
wait 2s
EVENT MACRO 1 0 forward one
wait 2s
return


sub moveup
EVENT MACRO 1 0 turn around
wait 2s
EVENT MACRO 1 0 forward
ContinueMoveUp:
if #CHARPOSX < %Xmin
{
EVENT MACRO 1 0 turn around
wait 2s
EVENT MACRO 1 0 stop
}
else
goto ContinueMoveUp
return

sub PosaPerle

set %Perle WWS
set %Book ZBN
set %Chiave REG

;Verifica se ci sono Perle
finditem %Perle C_ , #BACKPACKID
set %Perle #findid
if #findkind = -1 return

else
{
;Sacred journey verso casa
event macro 15 210
wait 2

;Clikka sul runebook
finditem %Book C_ , #backpackid
set %Book #findid
set #ltargetid %Book
set #ltargetkind 1
target
event macro 22 0
wait 2

;Entra in casa
set %POSY #CHARPOSY - 7
move #CHARPOSX %POSY 1 3s
wait 3s

;Posa le perle nel contenitore
exevent Drag %Perle #findstack
wait 1s
exevent Dropc MNWVQMD
wait 1s


set %oldx #CHARPOSX


while %oldx = #CHARPOSX
{
;Sacred journey alla barca
event macro 15 210
wait 2

;Clikka sulla chiave
finditem %Chiave C_ , #backpackid
set %Chiave #findid
set #ltargetid %Chiave
set #ltargetkind 1
target
event macro 22 0
wait 3s
}

}


return




sub TagliaPesci
;Sets up variables

set %pause 1000
set %cleaver INF
set %pesci GQD_EQD_DQD_FQD


;Cutting routines.
finditem %cleaver C_ , #BACKPACKID
if #findkind = -1
{
event sysmessage non hai un machete
return
}
set %cleaver #findid
set #lobjectid %cleaver

Cut:
finditem %pesci
if #findkind = -1
{
event sysmessage Non ci sono pesci da tagliare
return
}
set #ltargetid #findid
set #ltargetkind 1
Event Macro 17 0
target
event macro 22 0
sleep %pause
goto cut
return




sub Difenditi

EVENT MACRO 1 0 stop
finditem %seaSerpent G_10

if #enemyid = N/A
set %serp #FINDID

else
set %serp #enemyid

killloop:

;event macro 15 17 ;Cast Fireball
event macro 15 29 ;Cast Lightening
set #ltargetkind 1
set #ltargetid %serp
target
event macro 22 0 ;last target

If #Hits < #maxHits
{
event macro 15 202
target
event macro 23
wait 10
}

wait 2s

finditem %serp G_10
if #findkind <> -1
goto killloop

return




sub Cast_Protection
loopcastprot:
if #AR = N/A
gosub apri_gump
set !actar #AR
ricastprot:
set !jicp #JINDEX + 1
event macro 15 14
waitcastprot:
wait 20
for !jscp !jicp #JINDEX
{
scanjournal !jscp
if You_have_not_yet_recovered in #journal
{
wait 50
DELETEJOURNAL
goto ricastprot
}
}
if #ar = !actar
goto waitcastprot
if #ar > !actar
{
wait 50
goto loopcastprot
}
return

sub Apri_Gump
_OPEN_PAPERDOLL:
set %error #scnt + 1
event macro 8 1
loopa:
if #contname = PAPERDOLL_GUMP
{
goto fineloopa
}

if #scnt > %error
goto _OPEN_PAPERDOLL
}
goto loopa
fineloopa:
wait 10


wait 10
set %paperdollx #CONTPOSX
set %paperdolly #CONTPOSY

_OPEN_STATUS:
set %error #scnt + 1
event macro 8 2
loopb:
if #contname = STATUS_GUMP
{
goto fineloopb
}

if #scnt > %error
goto _OPEN_STATUS
}
goto loopb
fineloopb:
wait 10

_OPEN_BACKPACK:
set %error #scnt + 1
event macro 8 7
loopc:
if #contID = #backpackid
{
goto fineloopc
}

if #scnt > %error
goto _OPEN_BACKPACK
}
goto loopc
fineloopc:
wait 10
;contpos 400 493
set %zainox #CONTPOSX
set %zainoy #CONTPOSY


return